{% extends "shared/layout.html" %}

{% block title %}Chaosgraph | vibeBox{% endblock %}

{% block header_title %}Chaosgraph Generator{% endblock %}

{% block additional_styles %}
<style>
    .action-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #1E1E1E;
        border-radius: 0.75rem;
        padding: 0.5rem 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        flex-wrap: wrap;
        border: 1px solid #3D3D3D;
    }
    .action-bar > div {
        margin-right: 1rem;
        margin-bottom: 0.5rem;
    }
    .action-bar > div:last-child {
        margin-right: 0;
    }
    .action-bar label {
        display: inline-block;
        margin-right: 0.5rem;
        font-weight: 500;
        color: #D1D5DB;
    }
    .action-bar select {
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        border: 1px solid #3D3D3D;
        background-color: #2D2D2D;
        color: #D1D5DB;
        vertical-align: middle;
    }

    .controls {
        background-color: #1E1E1E;
        border-radius: 0.75rem;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: flex-start;
        border: 1px solid #3D3D3D;
    }
    .slider-container, .toggle-container-inline {
        margin-bottom: 0.75rem;
        width: 30%;
    }
    .controls label {
        display: block;
        margin-bottom: 0.25rem;
        font-weight: 600;
        color: #D1D5DB;
    }
    .controls .toggle-container-inline label {
        display: inline-block;
        margin-left: 0.25rem;
        font-weight: 500;
    }
    .controls input[type="checkbox"] {
        vertical-align: middle;
        margin-right: 0.25rem;
    }
    input[type="range"] {
        width: 100%;
        -webkit-appearance: none;
        height: 6px;
        background: #3D3D3D;
        border-radius: 3px;
        outline: none;
    }
    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #6E44FF;
        cursor: pointer;
    }
    
    input[type="range"]::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #6E44FF;
        cursor: pointer;
        border: none;
    }
    #spirograph-container {
        background-color: #121212;
        border-radius: 0.75rem;
        padding: 0;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        text-align: center;
        position: relative;
        border: 1px solid #3D3D3D;
        overflow: hidden;
    }
    svg#spirograph {
        background-color: #121212;
        border-radius: 0.75rem;
        width: 100%;
        max-width: 800px;
        height: auto;
        margin: 0 auto;
    }

    .action-button {
        padding: 0.375rem 0.75rem;
        background-color: #2D2D2D;
        border: 1px solid #3D3D3D;
        border-radius: 0.375rem;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 500;
        color: #D1D5DB;
        transition: background-color 0.2s ease;
        vertical-align: middle;
    }
    .action-button:hover {
        background-color: #3D3D3D;
    }
    
    .random-btn {
        background: linear-gradient(to right, #6E44FF, #4285F4);
        color: white;
        border: none;
    }
    .random-btn:hover {
        opacity: 0.9;
    }

    .toggle-container-inline {
        width: auto;
        margin-bottom: 0;
    }
    .toggle-container-inline label {
        display: inline-block;
        margin-left: 5px;
        font-weight: normal;
        color: #D1D5DB;
    }
    .toggle-container-inline input[type="checkbox"] {
        vertical-align: middle;
    }
    
    /* .gear-inset {
        position: absolute;
        bottom: 10px;
        right: 10px;
        width: 150px;
        height: 150px;
        background-color: rgba(30, 30, 30, 0.8);
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        border: 1px solid #3D3D3D;
    } Removed */
</style>
{% endblock %}

{% block additional_head %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
    // The entire spirograph JavaScript goes here
    document.addEventListener('DOMContentLoaded', function() {
        // Spirograph parameters
        let outerRadius = parseInt(document.getElementById('outer-radius').value);
        let middleRadius = parseInt(document.getElementById('middle-radius').value);
        let innerRadius = parseInt(document.getElementById('inner-radius').value);
        let penOffsetFromCenter = parseInt(document.getElementById('offset').value);
        let speed = parseInt(document.getElementById('speed').value);
        let useMiddleGear = document.getElementById('use-middle-gear').checked;
        
        // D3 setup
        const svgWidth = 800;
        const svgHeight = 800;
        const centerX = svgWidth / 2;
        const centerY = svgHeight / 2;
        
        const svg = d3.select('#spirograph')
            .attr('viewBox', `0 0 ${svgWidth} ${svgHeight}`)
            .attr('width', '100%')
            .attr('height', 'auto')
            .attr('preserveAspectRatio', 'xMidYMid meet');
        
        // Add a group for the main spirograph
        const spirographGroup = svg.append('g')
            .attr('transform', `translate(${centerX}, ${centerY})`);
        
        // Add path for the spirograph
        const path = spirographGroup.append('path')
            .attr('fill', 'none')
            .attr('stroke', '#6E44FF')
            .attr('stroke-width', 2);
        
        // Add circle for outer gear
        const outerGear = spirographGroup.append('circle')
            .attr('r', outerRadius)
            .attr('fill', 'none')
            .attr('stroke', '#bbb')
            .attr('stroke-width', 2)
            .attr('stroke-dasharray', '3,3');
        
        // Add circle for middle gear
        const middleGear = spirographGroup.append('circle')
            .attr('r', middleRadius)
            .attr('fill', 'none')
            .attr('stroke', '#aaa')
            .attr('stroke-width', 1)
            .attr('stroke-dasharray', '2,2');
        
        // Add circle for inner gear
        const innerGear = spirographGroup.append('circle')
            .attr('fill', 'none')
            .attr('stroke', '#999')
            .attr('stroke-width', 1);
        
        // Add point showing pen position
        const penPoint = spirographGroup.append('circle')
            .attr('r', 4)
            .attr('fill', '#FF3366');
        
        // Variables for animation
        let t = 0;
        let isAnimating = true;
        let pathData = [];
        
        // Function to clear the spirograph
        function clearSpirograph() {
            pathData = [];
            path.attr('d', '');
        }
        
        // Function to update sliders
        function updateSlider(id, value) {
            document.getElementById(id).value = value;
            document.getElementById(`${id}-value`).textContent = value;
        }
        
        // Function to calculate a point on the spirograph
        function calculatePoint(t) {
            let point = {x: 0, y: 0};
            
            if (useMiddleGear) {
                // Three-wheel spirograph
                const middleGearCenterX = (outerRadius - middleRadius) * Math.cos(t);
                const middleGearCenterY = (outerRadius - middleRadius) * Math.sin(t);
                
                const middleGearRotation = ((outerRadius - middleRadius) / middleRadius) * t;
                
                const innerGearCenterXRelativeToMiddle = (middleRadius - innerRadius) * Math.cos(middleGearRotation);
                const innerGearCenterYRelativeToMiddle = (middleRadius - innerRadius) * Math.sin(middleGearRotation);
                
                const innerGearAbsCenterX = middleGearCenterX + innerGearCenterXRelativeToMiddle;
                const innerGearAbsCenterY = middleGearCenterY + innerGearCenterYRelativeToMiddle;
                
                const penArmRotationOnInnerGear = ((middleRadius - innerRadius) / innerRadius) * middleGearRotation;
                
                point.x = innerGearAbsCenterX + penOffsetFromCenter * Math.cos(penArmRotationOnInnerGear);
                point.y = innerGearAbsCenterY - penOffsetFromCenter * Math.sin(penArmRotationOnInnerGear);
            } else {
                // Two-wheel spirograph
                const innerGearCenterX = (outerRadius - innerRadius) * Math.cos(t);
                const innerGearCenterY = (outerRadius - innerRadius) * Math.sin(t);
                
                const penArmRotationOnInnerGear = ((outerRadius - innerRadius) / innerRadius) * t;
                
                point.x = innerGearCenterX + penOffsetFromCenter * Math.cos(penArmRotationOnInnerGear);
                point.y = innerGearCenterY - penOffsetFromCenter * Math.sin(penArmRotationOnInnerGear);
            }
            
            return point;
        }
        
        // Animation function
        function animate() {
            if (!isAnimating) return;
            
            // Calculate the position at time t
            const point = calculatePoint(t);
            
            // Add the point to our path data
            pathData.push(point);
            
            // Update the path
            const lineFunction = d3.line()
                .x(d => d.x)
                .y(d => d.y);
            
            path.attr('d', lineFunction(pathData));
            
            // Update pen position display
            penPoint.attr('cx', point.x).attr('cy', point.y);
            
            // Update the position of the displayed gears
            if (useMiddleGear) {
                middleGear.attr('r', middleRadius); // Ensure middle gear has correct radius
                const middleGearDisplayCenterX = (outerRadius - middleRadius) * Math.cos(t);
                const middleGearDisplayCenterY = (outerRadius - middleRadius) * Math.sin(t);
                
                middleGear
                    .attr('cx', middleGearDisplayCenterX)
                    .attr('cy', middleGearDisplayCenterY);
                
                const middleGearDisplayRotation = ((outerRadius - middleRadius) / middleRadius) * t;
                
                const innerGearDisplayCenterX_relative = (middleRadius - innerRadius) * Math.cos(middleGearDisplayRotation);
                const innerGearDisplayCenterY_relative = (middleRadius - innerRadius) * Math.sin(middleGearDisplayRotation);
                
                const innerGearDisplayAbsCenterX = middleGearDisplayCenterX + innerGearDisplayCenterX_relative;
                const innerGearDisplayAbsCenterY = middleGearDisplayCenterY + innerGearDisplayCenterY_relative;
                
                innerGear
                    .attr('r', innerRadius)
                    .attr('cx', innerGearDisplayAbsCenterX)
                    .attr('cy', innerGearDisplayAbsCenterY);
            } else {
                middleGear.attr('r', 0); // Hide middle gear
                
                const innerGearDisplayCenterX = (outerRadius - innerRadius) * Math.cos(t);
                const innerGearDisplayCenterY = (outerRadius - innerRadius) * Math.sin(t);
                
                innerGear
                    .attr('r', innerRadius)
                    .attr('cx', innerGearDisplayCenterX)
                    .attr('cy', innerGearDisplayCenterY);
            }
            
            // Increment time
            t += 0.01 * speed;
            
            // Call the next frame
            requestAnimationFrame(animate);
        }
        
        // Set up event listeners for controls
        document.getElementById('outer-radius').addEventListener('input', function() {
            outerRadius = this.value;
            document.getElementById('outer-radius-value').textContent = outerRadius;
            outerGear.attr('r', outerRadius);
            clearSpirograph();
        });
        
        document.getElementById('middle-radius').addEventListener('input', function() {
            middleRadius = this.value;
            document.getElementById('middle-radius-value').textContent = middleRadius;
            clearSpirograph();
        });
        
        document.getElementById('inner-radius').addEventListener('input', function() {
            innerRadius = this.value;
            document.getElementById('inner-radius-value').textContent = innerRadius;
            clearSpirograph();
        });
        
        document.getElementById('offset').addEventListener('input', function() {
            penOffsetFromCenter = this.value;
            document.getElementById('offset-value').textContent = penOffsetFromCenter;
            clearSpirograph();
        });
        
        document.getElementById('speed').addEventListener('input', function() {
            speed = this.value;
            document.getElementById('speed-value').textContent = speed;
        });
        
        document.getElementById('use-middle-gear').addEventListener('change', function() {
            useMiddleGear = this.checked;
            // Toggle visibility of middle radius controls
            document.getElementById('middle-radius-container').style.display = useMiddleGear ? 'block' : 'none';
            clearSpirograph();
        });
        
        document.getElementById('clear-button').addEventListener('click', clearSpirograph);
        
        document.getElementById('random-button').addEventListener('click', function() {
            // Generate random values
            outerRadius = Math.floor(Math.random() * 120) + 150;
            middleRadius = Math.floor(Math.random() * 80) + 60;
            innerRadius = Math.floor(Math.random() * 30) + 20;
            penOffsetFromCenter = Math.floor(Math.random() * 70) + 30;
            speed = Math.floor(Math.random() * 5) + 3;
            
            // Update sliders
            updateSlider('outer-radius', outerRadius);
            updateSlider('middle-radius', middleRadius);
            updateSlider('inner-radius', innerRadius);
            updateSlider('offset', penOffsetFromCenter);
            updateSlider('speed', speed);
            
            // Clear and restart
            clearSpirograph();
        });
        
        document.getElementById('preset-selector').addEventListener('change', function() {
            if (this.value === 'custom') return;
            
            const values = this.value.split(',');
            outerRadius = parseInt(values[0]);
            middleRadius = parseInt(values[1]);
            innerRadius = parseInt(values[2]);
            
            // Update sliders
            updateSlider('outer-radius', outerRadius);
            updateSlider('middle-radius', middleRadius);
            updateSlider('inner-radius', innerRadius);
            
            this.value = 'custom';
            clearSpirograph();
        });
        
        // Start animation
        animate();
    });
</script>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 max-w-[800px]">
    <div class="mb-6">
        <p class="text-gray-400">Hello! Generate beautiful spirograph patterns with adjustable parameters</p>
    </div>

    <div class="action-bar">
        <button id="random-button" class="action-button random-btn">Random</button>
        <div class="preset-container">
            <label for="preset-selector">Presets:</label>
            <select id="preset-selector">
                <option value="custom" selected>Custom</option>
                <option value="202,100,20">Starter</option>
                <option value="200,100,50">Nested 2:1 + 2:1</option>
                <option value="240,120,40">Nested 2:1 + 3:1</option>
                <option value="150,90,60">Commensurable 5:3 + 3:2</option>
                <option value="210,150,90">Commensurable 7:5 + 5:3</option>
                <option value="120,80,60">Commensurable 3:2 + 4:3</option>
                <option value="200,100,61">Nested Int + Complex</option>
                <option value="150,101,68">Near Resonance</option>
            </select>
        </div>
        <div class="toggle-container-inline">
            <input type="checkbox" id="use-middle-gear" checked>
            <label for="use-middle-gear">Use 3 Gears</label>
        </div>
        <button id="clear-button" class="action-button">Clear Trail</button>
    </div>

    <div class="controls">
        <div class="slider-container">
            <label for="outer-radius">Outer Radius: <span id="outer-radius-value">205</span></label>
            <input type="range" id="outer-radius" min="50" max="300" value="202">
        </div>
        <div class="slider-container" id="middle-radius-container">
            <label for="middle-radius">Middle Radius: <span id="middle-radius-value">100</span></label>
            <input type="range" id="middle-radius" min="20" max="299" value="100">
        </div>
        <div class="slider-container">
            <label for="inner-radius">Inner Radius: <span id="inner-radius-value">25</span></label>
            <input type="range" id="inner-radius" min="10" max="298" value="20">
        </div>
        <div class="slider-container">
            <label for="offset">Pen Offset: <span id="offset-value">10</span></label>
            <input type="range" id="offset" min="1" max="150" value="10">
        </div>
        <div class="slider-container">
            <label for="speed">Speed: <span id="speed-value">8</span></label>
            <input type="range" id="speed" min="1" max="10" value="8">
        </div>
    </div>

    <div id="spirograph-container">
        <svg id="spirograph"></svg>
    </div>
</div>
{% endblock %}
